<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ููุญุฉ ุงูุฃุฏูู</title>

<link rel="stylesheet" href="style.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="app.js"></script>
</head>

<body>
<div class="header">๐ ููุญุฉ ุชุญูู ุงูุฃุฏูู</div>

<div class="container">
  <div class="card">
    <p class="small">ุงูุฏุฎูู ูุณููุญ ููุท ูุฅูููู ุงูุฃุฏูู</p>
    <p class="status" id="status"></p>

    <div class="row">
      <button class="btn btn-blue" onclick="showTab('users')">๐ฅ ุงููุณุชุฎุฏููู</button>
      <button class="btn btn-blue" onclick="showTab('withdrawals')">๐ค ุงูุณุญูุจุงุช</button>
    </div>

    <div class="row">
      <button class="btn btn-blue" onclick="showTab('deposits')">๐ณ ุงูุฅูุฏุงุนุงุช</button>
      <button class="btn btn-gold" onclick="showTab('ads')">๐บ ุงูุฅุนูุงูุงุช</button>
    </div>
  </div>

  <!-- ุงููุณุชุฎุฏููู -->
  <div class="card" id="tab-users" style="display:none">
    <div class="small">ุงููุณุชุฎุฏููู + ุงูุฃุฑุตุฏุฉ</div>
    <div id="usersList" class="list"></div>
  </div>

  <!-- ุงูุณุญูุจุงุช -->
  <div class="card" id="tab-withdrawals" style="display:none">
    <div class="small">ุทูุจุงุช ุงูุณุญุจ</div>
    <div id="withList" class="list"></div>
  </div>

  <!-- ุงูุฅูุฏุงุนุงุช -->
  <div class="card" id="tab-deposits" style="display:none">
    <div class="small">ุทูุจุงุช ุงูุฅูุฏุงุน</div>
    <div id="depList" class="list"></div>
  </div>

  <!-- ุงูุฅุนูุงูุงุช -->
  <div class="card" id="tab-ads" style="display:none">
    <div class="small">ุฅุถุงูุฉ ุฅุนูุงู ุฌุฏูุฏ</div>

    <label class="label">ุนููุงู ุงูุฅุนูุงู</label>
    <input id="adTitle" placeholder="ูุซุงู: ุฅุนูุงู #1"/>

    <label class="label">ุฑุงุจุท ุงูููุฏูู (mp4)</label>
    <input id="adUrl" placeholder="https://example.com/video.mp4"/>

    <label class="label">ููุงุท ุงูุฅุนูุงู</label>
    <input id="adPts" type="number" value="3"/>

    <button class="btn btn-green" onclick="addAd()">โ ุฅุถุงูุฉ ุงูุฅุนูุงู</button>

    <div id="adsList" class="list"></div>
  </div>
</div>

<script>
const statusEl = document.getElementById("status");
const tabs = ["users","withdrawals","deposits","ads"];

function showTab(name){
  tabs.forEach(t=>{
    document.getElementById("tab-"+t).style.display = (t===name) ? "block" : "none";
  });
  if(name==="users") loadUsers();
  if(name==="withdrawals") loadWithdrawals();
  if(name==="deposits") loadDeposits();
  if(name==="ads") loadAds();
}

(async()=>{
  const s = await requireAuth();
  if(!s) return;

  if(!(await isAdminEmail())){
    statusEl.textContent="๐ซ ุบูุฑ ูุตุฑุญ ูู ุจุงูุฏุฎูู";
    setTimeout(()=>location.href="home.html",1000);
    return;
  }
  statusEl.textContent="ูุฑุญุจุงู ุฃุฏูู โ";
  showTab("deposits");
})();

/* ===== ุงููุณุชุฎุฏููู ===== */
async function loadUsers(){
  const { data, error } = await supabase.from("user_balance").select("*");
  const box = document.getElementById("usersList");
  box.innerHTML="";
  if(error){ box.innerHTML="ุฎุทุฃ"; return; }

  data.forEach(u=>{
    box.innerHTML+=`
      <div class="item">
        <div class="title">${u.user_id}</div>
        <div class="meta">ุงูุฑุตูุฏ: $${u.balance}</div>
        <input id="bal_${u.user_id}" type="number" placeholder="ุชุนุฏูู ุงูุฑุตูุฏ"/>
        <button class="btn btn-gold" onclick="updateBalance('${u.user_id}')">ุญูุธ</button>
      </div>`;
  });
}

async function updateBalance(uid){
  const amount = Number(document.getElementById("bal_"+uid).value||0);
  const { error } = await supabase.rpc("admin_update_balance",{ target_user: uid, amount });
  alert(error ? error.message : "ุชู ุงูุชุนุฏูู โ");
  loadUsers();
}

/* ===== ุงูุณุญูุจุงุช ===== */
async function loadWithdrawals(){
  const { data } = await supabase.from("withdrawals").select("*").order("id",{ascending:false});
  const box=document.getElementById("withList"); box.innerHTML="";
  data.forEach(w=>{
    box.innerHTML+=`
      <div class="item">
        <div class="title">ุณุญุจ #${w.id} โ $${w.amount}</div>
        <div class="meta">${w.wallet}</div>
        <span class="badge ${badgeClass(w.status)}">${w.status}</span>
        <div class="row">
          <button class="btn btn-green" onclick="approveW(${w.id},'${w.user_id}',${w.amount})">ููุงููุฉ</button>
          <button class="btn btn-red" onclick="rejectW(${w.id})">ุฑูุถ</button>
        </div>
      </div>`;
  });
}

async function approveW(id,uid,amount){
  await supabase.from("withdrawals").update({status:"approved"}).eq("id",id);
  await supabase.rpc("admin_update_balance",{ target_user: uid, amount: -amount });
  loadWithdrawals();
}
async function rejectW(id){
  await supabase.from("withdrawals").update({status:"rejected"}).eq("id",id);
  loadWithdrawals();
}

/* ===== ุงูุฅูุฏุงุนุงุช ===== */
async function loadDeposits(){
  const { data } = await supabase.from("deposits").select("*").order("id",{ascending:false});
  const box=document.getElementById("depList"); box.innerHTML="";
  data.forEach(d=>{
    box.innerHTML+=`
      <div class="item">
        <div class="title">ุฅูุฏุงุน #${d.id} โ $${d.amount_usd}</div>
        <span class="badge ${badgeClass(d.status)}">${d.status}</span>
        <div class="row">
          <button class="btn btn-green" onclick="approveD(${d.id},'${d.user_id}',${d.amount_usd})">ููุงููุฉ</button>
          <button class="btn btn-red" onclick="rejectD(${d.id})">ุฑูุถ</button>
        </div>
      </div>`;
  });
}

async function approveD(id,uid,amount){
  await supabase.from("deposits").update({status:"approved"}).eq("id",id);
  await supabase.rpc("admin_update_balance",{ target_user: uid, amount });
  loadDeposits();
}
async function rejectD(id){
  await supabase.from("deposits").update({status:"rejected"}).eq("id",id);
  loadDeposits();
}

/* ===== ุงูุฅุนูุงูุงุช ===== */
async function addAd(){
  const title=document.getElementById("adTitle").value;
  const url=document.getElementById("adUrl").value;
  const pts=Number(document.getElementById("adPts").value||3);
  if(!url) return alert("ุถุน ุฑุงุจุท ุงูููุฏูู");
  await supabase.from("ads").insert({ title, video_url:url, reward_points:pts, is_active:true });
  loadAds();
}

async function loadAds(){
  const { data } = await supabase.from("ads").select("*").order("id",{ascending:false});
  const box=document.getElementById("adsList"); box.innerHTML="";
  data.forEach(a=>{
    box.innerHTML+=`
      <div class="item">
        <div class="title">#${a.id} ${a.title||""}</div>
        <div class="meta">${a.video_url}</div>
      </div>`;
  });
}
</script>
</body>
</html>
