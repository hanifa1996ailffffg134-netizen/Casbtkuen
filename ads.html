<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø¨ÙŠØªÙƒÙˆÙŠÙ† ÙƒØ§Ø´ - Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
<link rel="stylesheet" href="style.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="app.js"></script>
</head>
<body>
<div class="header">Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>

<div class="container">
  <div class="card">
    <div class="small">Ø´Ø§Ù‡Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© Ø«Ù… Ø§Ø¶ØºØ· ØªÙ…Ù‘Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
    <p class="status" id="status"></p>
  </div>
  <div id="list" class="list"></div>
</div>

<div class="nav">
  <a href="home.html" data-nav="home"><span class="ico">ğŸ </span><small>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</small></a>
  <a href="ads.html" data-nav="ads" class="active"><span class="ico">ğŸ“º</span><small>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</small></a>
  <a href="wallet.html" data-nav="wallet"><span class="ico">ğŸ’¼</span><small>Ø§Ù„Ù…Ø­ÙØ¸Ø©</small></a>
  <a href="about.html" data-nav="about"><span class="ico">â„¹ï¸</span><small>Ù…Ù† Ù†Ø­Ù†</small></a>
</div>

<script>
setNav("ads");
const listEl = document.getElementById("list");
const statusEl = document.getElementById("status");

async function loadAds(){
  const s = await requireAuth(); if(!s) return;
  const { data, error } = await supabase.from("ads").select("*").eq("is_active", true).order("id",{ascending:false});
  if(error){ statusEl.textContent="Ø®Ø·Ø£: "+error.message; return; }
  listEl.innerHTML="";
  if(!data || data.length===0){ listEl.innerHTML='<div class="item"><div class="title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div></div>'; return; }

  data.forEach(ad=>{
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`
      <div class="top">
        <div>
          <div class="title">ğŸ“º ${ad.title||("Ø¥Ø¹Ù„Ø§Ù† #"+ad.id)}</div>
          <div class="meta">Ø§Ù„Ø±Ø¨Ø­: ${ad.reward_points||3} Ù†Ù‚Ø§Ø· (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</div>
        </div>
        <span class="badge pending" id="b-${ad.id}">Ø¬Ø§Ù‡Ø²</span>
      </div>
      <video id="v-${ad.id}" controls playsinline src="${ad.video_url}"></video>
      <button class="btn btn-green" id="btn-${ad.id}" disabled>ØªÙ…Ù‘Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© âœ…</button>
    `;
    listEl.appendChild(el);

    const vid=document.getElementById(`v-${ad.id}`);
    const btn=document.getElementById(`btn-${ad.id}`);
    const badge=document.getElementById(`b-${ad.id}`);

    vid.addEventListener("ended",()=>{ btn.disabled=false; badge.textContent="Ø§Ù†ØªÙ‡Ù‰"; badge.className="badge approved"; });
    btn.addEventListener("click", async ()=>{
      btn.disabled=true; badge.textContent="Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...";
      const { error } = await supabase.rpc("watch_ad_once",{ p_ad_id: ad.id });
      if(error){ badge.textContent="Ù…Ø±ÙÙˆØ¶"; badge.className="badge rejected"; statusEl.textContent="Ø®Ø·Ø£: "+error.message; return; }
      badge.textContent="ØªÙ… âœ…"; badge.className="badge approved"; statusEl.textContent="ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· âœ…";
    });
  });
}
loadAds();
</script>
</body>
</html>
